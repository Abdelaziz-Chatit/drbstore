<div class="page-header">
    <h1>Manage Users</h1>
    <p>Add, edit, and manage user accounts</p>
</div>

<div style="margin-bottom: 2rem;">
    <button type="button" class="btn btn-success" onclick="openCreateModal()" style="background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">+ New User</button>
</div>

<table>
    <thead>
        <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Roles</th>
            <th>Created</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        <% if (typeof users !== 'undefined' && users.length > 0) { %>
            <% users.forEach(user => { %>
            <tr>
                <td><strong><%= user.name %></strong></td>
                <td><%= user.email %></td>
                <td><%= user.phone || 'N/A' %></td>
                <td>
                    <% 
                        let roles = [];
                        try {
                            roles = typeof user.roles === 'string' ? JSON.parse(user.roles) : user.roles;
                        } catch(e) {
                            roles = ['ROLE_USER'];
                        }
                    %>
                    <% roles.forEach(role => { %>
                        <% if (role === 'ROLE_ADMIN') { %>
                            <span class="badge" style="background-color: #dc3545; color: white;">Admin</span>
                        <% } else if (role === 'ROLE_RESPONSABLE') { %>
                            <span class="badge" style="background-color: #ffc107; color: #333;">Manager</span>
                        <% } else if (role === 'ROLE_USER') { %>
                            <span class="badge" style="background-color: #17a2b8; color: white;">User</span>
                        <% } %>
                    <% }); %>
                </td>
                <td><%= new Date(user.created_at).toLocaleDateString() %></td>
                <td>
                    <div style="display: flex; gap: 5px;">
                        <button type="button" class="btn btn-info btn-sm" onclick="openUserEditModal(<%= user.id %>, '<%= user.name.replace(/'/g, "\\'") %>', '<%= user.email %>', '<%= user.phone || '' %>', '<%= user.roles %>')" style="background-color: #007bff; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer;">Edit</button>
                        <form method="POST" action="/admin/users/<%= user.id %>/delete" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this user?');">
                            <button type="submit" class="btn btn-danger btn-sm" style="background-color: #dc3545; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer;">Delete</button>
                        </form>
                    </div>
                </td>
            </tr>
            <% }); %>
        <% } else { %>
            <tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-secondary);">No users found</td></tr>
        <% } %>
    </tbody>
</table>


<!-- Create/Edit User Modal -->
<div id="userModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; display: none; align-items: center; justify-content: center;">
    <div style="background-color: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <h2 style="margin-top: 0;" id="modalTitle">Create New User</h2>
        
        <form id="userForm" method="POST" action="/admin/users">
            <input type="hidden" id="userId" name="userId">
            
            <div class="form-group">
                <label>Name *</label>
                <input type="text" id="name" name="name" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label>Email *</label>
                <input type="email" id="email" name="email" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label>Password <span id="passwordLabel">*</span></label>
                <input type="password" id="password" name="password" class="form-control" required>
                <small id="passwordHint" style="color: var(--text-secondary); display: block; margin-top: 0.5rem;"></small>
            </div>
            
            <div class="form-group">
                <label>Phone</label>
                <input type="tel" id="phone" name="phone" class="form-control">
            </div>
            
            <div class="form-group">
                <label>Roles</label>
                <div style="display: flex; gap: 15px; margin-top: 10px;">
                    <label>
                        <input type="checkbox" id="roleUser" name="roles" value="ROLE_USER" checked> User
                    </label>
                    <label>
                        <input type="checkbox" id="roleManager" name="roles" value="ROLE_RESPONSABLE"> Manager
                    </label>
                    <label>
                        <input type="checkbox" id="roleAdmin" name="roles" value="ROLE_ADMIN"> Admin
                    </label>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="closeUserModal()" style="background-color: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                <button type="submit" class="btn btn-primary" style="background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">Save User</button>
            </div>
        </form>
    </div>
</div>

<div style="margin-top: 2rem;">
    <a href="<% if (user.roles.includes('ROLE_ADMIN')) { %>/admin<% } else { %>/admin/manager-dashboard<% } %>" class="btn btn-outline">‚Üê Back to Dashboard</a>
</div>

<style>
    @keyframes slideIn {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    #userModal[data-open="true"] {
        display: flex !important;
    }

    .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        margin-right: 5px;
    }
</style>

<script>
    function openCreateModal() {
        document.getElementById('modalTitle').textContent = 'Create New User';
        document.getElementById('userForm').action = '/admin/users';
        document.getElementById('userForm').method = 'POST';
        document.getElementById('userId').value = '';
        document.getElementById('name').value = '';
        document.getElementById('email').value = '';
        document.getElementById('password').value = '';
        document.getElementById('phone').value = '';
        document.getElementById('passwordLabel').textContent = '*';
        document.getElementById('passwordHint').textContent = '';
        document.getElementById('password').required = true;
        
        // Reset checkboxes
        document.getElementById('roleUser').checked = true;
        document.getElementById('roleManager').checked = false;
        document.getElementById('roleAdmin').checked = false;
        
        openUserModal();
    }

    function openUserEditModal(userId, userName, userEmail, userPhone, userRoles) {
        document.getElementById('modalTitle').textContent = 'Edit User';
        document.getElementById('userForm').action = '/admin/users/' + userId;
        document.getElementById('userId').value = userId;
        document.getElementById('name').value = userName;
        document.getElementById('email').value = userEmail;
        document.getElementById('password').value = '';
        document.getElementById('phone').value = userPhone;
        document.getElementById('passwordLabel').textContent = '';
        document.getElementById('passwordHint').textContent = 'Leave blank to keep current password';
        document.getElementById('password').required = false;
        
        // Parse roles
        let roles = [];
        try {
            roles = typeof userRoles === 'string' ? JSON.parse(userRoles) : userRoles;
        } catch(e) {
            roles = ['ROLE_USER'];
        }
        
        document.getElementById('roleUser').checked = roles.includes('ROLE_USER');
        document.getElementById('roleManager').checked = roles.includes('ROLE_RESPONSABLE');
        document.getElementById('roleAdmin').checked = roles.includes('ROLE_ADMIN');
        
        openUserModal();
    }

    function openUserModal() {
        document.getElementById('userModal').setAttribute('data-open', 'true');
        document.getElementById('userModal').style.display = 'flex';
    }

    function closeUserModal() {
        document.getElementById('userModal').removeAttribute('data-open');
        document.getElementById('userModal').style.display = 'none';
    }

    // Close modal when clicking outside
    document.getElementById('userModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeUserModal();
        }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeUserModal();
        }
    });
</script>
